
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Open Source Docs and Community Standards">
      
      
      
        <meta name="author" content="Data Tools">
      
      
        <link rel="canonical" href="https://homeaway.github.io/datapull/install_on_aws/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.4">
    
    
      
        <title>Installing DataPull on AWS Fargate and S3 - DataPull Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bde7dde4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#deploying-datapull-on-aws-fargateecs-and-aws-emr" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="DataPull Documentation" class="md-header__button md-logo" aria-label="DataPull Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DataPull Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Installing DataPull on AWS Fargate and S3
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/homeaway/datapull/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    homeaway/datapull
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="DataPull Documentation" class="md-nav__button md-logo" aria-label="DataPull Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    DataPull Documentation
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/homeaway/datapull/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    homeaway/datapull
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      <label class="md-nav__link" for="__nav_3">
        DataPull on AWS
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="DataPull on AWS" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          DataPull on AWS
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Installing DataPull on AWS Fargate and S3
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Installing DataPull on AWS Fargate and S3
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pre-install-steps" class="md-nav__link">
    Pre-install steps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installation-steps" class="md-nav__link">
    Installation Steps
  </a>
  
    <nav class="md-nav" aria-label="Installation Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#edit-master_application_config-envyml" class="md-nav__link">
    Edit master_application_config-{{env}}.yml
  </a>
  
    <nav class="md-nav" aria-label="Edit master_application_config-{{env}}.yml">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#required-attributes-excluding-those-with-defaulted-values" class="md-nav__link">
    Required attributes (excluding those with defaulted values)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-attributes" class="md-nav__link">
    Optional attributes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-oracle-and-teradata-support" class="md-nav__link">
    (optional) Oracle and Teradata support
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-datapull-infrastructure" class="md-nav__link">
    Create DataPull Infrastructure
  </a>
  
    <nav class="md-nav" aria-label="Create DataPull Infrastructure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optional-add-support-for-datapull-api-to-be-served-over-https" class="md-nav__link">
    (optional) Add support for DataPull API to be served over HTTPS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-iam-user-and-roles-with-policies" class="md-nav__link">
    Create IAM User and Roles, with policies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-aws-fargate-api-app-and-other-aws-resources" class="md-nav__link">
    Create AWS Fargate API App and other AWS resources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#browse-to-the-datapull-api-swagger-endpoint" class="md-nav__link">
    Browse to the DataPull API Swagger endpoint
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#do-your-first-datapull" class="md-nav__link">
    Do your first DataPull
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../aws_account_setup/" class="md-nav__link">
        Setup VPC etc. in AWS Account for DataPull install
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../emr_runbook/" class="md-nav__link">
        Running DataPull on AWS EMR
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../custom_emr_ec2_role/" class="md-nav__link">
        Custom EC2 Role for EMR
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../uninstall_on_aws/" class="md-nav__link">
        Uninstalling DataPull on AWS Fargate and S3
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../oracle_teradata_support/" class="md-nav__link">
        Support for Oracle and Teradata
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../transformation/" class="md-nav__link">
        Sample input JSON
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../monitor_spark_ui/" class="md-nav__link">
        Monitor DataPull jobs using Spark UI
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        FAQs
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pre-install-steps" class="md-nav__link">
    Pre-install steps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installation-steps" class="md-nav__link">
    Installation Steps
  </a>
  
    <nav class="md-nav" aria-label="Installation Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#edit-master_application_config-envyml" class="md-nav__link">
    Edit master_application_config-{{env}}.yml
  </a>
  
    <nav class="md-nav" aria-label="Edit master_application_config-{{env}}.yml">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#required-attributes-excluding-those-with-defaulted-values" class="md-nav__link">
    Required attributes (excluding those with defaulted values)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-attributes" class="md-nav__link">
    Optional attributes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-oracle-and-teradata-support" class="md-nav__link">
    (optional) Oracle and Teradata support
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-datapull-infrastructure" class="md-nav__link">
    Create DataPull Infrastructure
  </a>
  
    <nav class="md-nav" aria-label="Create DataPull Infrastructure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optional-add-support-for-datapull-api-to-be-served-over-https" class="md-nav__link">
    (optional) Add support for DataPull API to be served over HTTPS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-iam-user-and-roles-with-policies" class="md-nav__link">
    Create IAM User and Roles, with policies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-aws-fargate-api-app-and-other-aws-resources" class="md-nav__link">
    Create AWS Fargate API App and other AWS resources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#browse-to-the-datapull-api-swagger-endpoint" class="md-nav__link">
    Browse to the DataPull API Swagger endpoint
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#do-your-first-datapull" class="md-nav__link">
    Do your first DataPull
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/homeaway/datapull/edit/master/docs/docs/install_on_aws.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="deploying-datapull-on-aws-fargateecs-and-aws-emr">Deploying DataPull on AWS Fargate/ECS and AWS EMR</h1>
<p>This document helps you install DataPull on an Amazon AWS account, and run your first DataPull job of converting CSV data in AWS S3 to JSON data. </p>
<p><img alt="DataPull installation on AWS" src="../media/datapull_installation.png" /></p>
<p>In a nutshell, deploying DataPull to an AWS Account</p>
<ul>
<li>creates four IAM Roles<ul>
<li><code>datapull_task_role</code>, <code>datapull_task_execution_role</code> for running the DataPull REST API on AWS Fargate</li>
<li><code>emr_datapull_role</code>, <code>emr_ec2_datapull_role</code> for running ephemeral AWS EMR clusters</li>
</ul>
</li>
<li>creates an IAM User <code>datapull_user</code> temporarily for the purpose of installing the following DataPull components<ul>
<li>an AWS Fargate service <code>datapull-web-api</code> with an associated image in AWS ECR, and AWS Application Load Balancer (ALB)</li>
<li>an AWS CloudWatch Log Group <code>datapull_cloudwatch_log_group</code> and associated log stream</li>
</ul>
</li>
<li>stores DataPull JAR for EMR, job history, EMR logs in an existing AWS S3 bucket<blockquote>
<p>Note: <code>{{xyz}}</code> denotes a variable/attribute named <code>xyz</code> in the DataPull configuration file</p>
</blockquote>
</li>
</ul>
<h2 id="pre-install-steps">Pre-install steps</h2>
<ul>
<li>
<p>(optional but recommended, since it allows easy reinstalls, updates and uninstalls in the future) Fork/<a href="https://docs.github.com/en/github/creating-cloning-and-archiving-repositories/duplicating-a-repository">Mirror</a> this repo to your git org. All proceeding references to "repo" will refer to your forked/mirrored repo.</p>
<blockquote>
<p>Note: You will need to mirror instead of fork, if your org is not on github.com</p>
</blockquote>
</li>
<li>
<p>Clone/download the <code>master</code> branch of this repo for ECS Fargate-based install or <code>master_ecs_ec2</code> branch if you want to do ECS EC2-based install.</p>
</li>
<li>Have available, the <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html">AWS Profile</a> <code>{{aws_admin_profile}}</code> of an IAM user/role that can create IAM users and IAM roles in your AWS account<ul>
<li>It is advisable this IAM user/role have admin access to the AWS account. Typically these credentials will be available only to the team managing the AWS account; hence the team deploying DataPull will need to coordinate with the team managing the AWS account. </li>
</ul>
</li>
<li>Have an S3 bucket <code>{{s3_bucket_name}}</code> (this bucket can be an existing bucket or a new bucket) that DataPull will use to store artifacts and logs under the folder <code>datapull-opensource</code>. The installation will use the name name as the prefix for new resources needed by DataPull, such as ECS service, Application load balancer, etc.</li>
<li>Have available a VPC with ID <code>{{vpc_id}}</code> in the AWS region <code>{{region}}</code></li>
<li>Have available, two AWS VPC subnet ids <code>{{application_subnet_1}}</code>,  <code>{{application_subnet_2}}</code> in the region VPC with ID <code>{{vpc_id}}</code> accessible to your clients. These subnets should ideally be private subnets, for the sake of security.</li>
<li>Have available a security group with ID <code>{{application_security_group}}</code> that either your bastion node is a part of (for SSH-forwarding ports to your client network), or your client network has access to TCP ports 443 (if you wish to serve DataPull API over HTTPS), 8080 (if you wish to serve DataPull API over HTTP), 8088 (to access Spark Application Manager for monitoring DataPull), 20888 (to access Spark UI on EMR master for monitoring DataPull)<ul>
<li>if you are using DataPull in a dedicated/new VPC created by following <a href="/aws_account_setup">these instructions</a>, please use the ID of the security group <code>ElasticMapReduce-Master-Private</code></li>
</ul>
</li>
<li>Have Docker installed on the machine used for deployment</li>
<li>If you wish to serve the DataPull API over HTTPS (say, at <a href="https://datapull.yourdomain.com">https://datapull.yourdomain.com</a> ), have available <ul>
<li>the ARN <code>{{load_balancer_certificate_arn}}</code> of an existing Certificate stored in AWS Certificate Manager that is valid for <code>datapull.yourdomain.com</code></li>
<li>the ability to create/modify a CNAME record for <code>datapull.yourdomain.com</code> to point to the load balancer URL for the DataPull API that will be created later in these instructions.</li>
</ul>
</li>
<li>Choose which environment <code>{{env}}</code> this DataPull deployment is for. Valid environments are <ul>
<li><code>dev</code></li>
<li><code>test</code></li>
<li><code>stage</code></li>
<li><code>prod</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>Pro-tip: Record the values of the variables in the pre-install steps, as a text file. Here is an example (with fake values)...</p>
</blockquote>
<pre><code>{{aws_admin_profile}}: default
{{s3_bucket_name}}: datatools-datapull
{{vpc_id}}: vpc-071957e514a1fbd73
{{region}}: us-west-2
{{application_subnet_1}}: subnet-04903ae2649294308
{{application_subnet_2}}: subnet-0e10783af0de2513e
{{application_security_group}}: sg-08beb77f882d5d2a2
{{load_balancer_certificate_arn}}: arn:aws:acm:us-west-2:771905877783:certificate/2b1d3729-aa6d-47d5-8902-d0f9e75b35a8
{{env}}: stage
</code></pre>
<h2 id="installation-steps">Installation Steps</h2>
<h3 id="edit-master_application_config-envyml">Edit master_application_config-{{env}}.yml</h3>
<p>This file is present in the root directory of the repo.</p>
<h4 id="required-attributes-excluding-those-with-defaulted-values">Required attributes (excluding those with defaulted values)</h4>
<ul>
<li>datapull.application.region: Put <code>{{region}}</code> here</li>
<li>datapull.api.s3_bucket_name: Put <code>{{s3_bucket_name}}</code> here</li>
<li>datapull.api.application_subnet_1: Put <code>{{application_subnet_1}}</code> here</li>
<li>datapull.api.application_subnet_2: Put <code>{{application_subnet_2}}</code> here</li>
<li>datapull.api.application_security_group: Put <code>{{application_security_group}}</code> here</li>
<li>datapull.api.vpc_id: Put <code>{{vpc_id}}</code> here</li>
</ul>
<h4 id="optional-attributes">Optional attributes</h4>
<p>The following attributes need to be specified if you need DataPull to retrieve credentials from Hashicorp Vault to connect to your data stores</p>
<ul>
<li>datapull.secretstore.vault.vault_url: Put <code>{{vault_url}}</code> here</li>
<li>datapull.secretstore.vault.vault_nonce: Put a <a href="https://www.vaultproject.io/docs/auth/aws.html#client-nonce">Client nonce</a> here</li>
<li>datapull.secretstore.vault.static_secret_path_prefix: Put <code>{{static_secret_path_prefix}}</code> here</li>
<li>datapull.secretstore.vault.vault_path_login: Put the path to the login url for the AWS EC2 Auth endpoint. e.g. <code>/v1/auth/{{AWS Auth endpoint name}}/login</code></li>
</ul>
<p>For the above Vault integration to work, you need
<br />
<ul>
      <li> DataPull to run on AWS EMR (this is the default behaviour), or on a Spark cluster whose node(s) run on AWS EC2.
      <li> a Hashicorp Vault cluster whose API is accessible at `{{vault_url}}` (e.g. https://myvault.mydomain.com:8200)
      <li> credentials for the database cluster {{cluster}} in the format `{ "username": "{{username}}", "password": "{{password}}" }` stored as a static secret at the location `{{vault_url}}/{{static_secret_path_prefix}}/{{cluster}}/{{username}}` . For example, if you need DataPull to retrieve the credentials for the user `mydbuser` of the MySql cluster `mycluster` from the Vault cluster static secret path https://myvaultcluster:8200/v1/secret/mycluster/mydbuser , you will need to store the credentials using the cUrl command `curl -X POST https://myvaultcluster:8200/v1/secret/mycluster/mydbuser -H 'X-Vault-Token: {{valid Vault token}}' -d '{ "username": "mydbuser", "password": "{{password}}" }'`
      <li> [AWS EC2 Auth method](https://www.vaultproject.io/docs/auth/aws.html#ec2-auth-method) set up on the Vault cluster, and the IAM Role of the Spark cluster mapped to a Vault policy that allows it to read the secret at the location `{{vault_url}}/{{static_secret_path_prefix}}/{{cluster}}/{{username}}`
  </ul>
</p>
<p>The following attribute needs to set if the DataPull API needs to be served over HTTPS.
- datapull.api.load_balancer_certificate_arn: Put <code>{{load_balancer_certificate_arn}}</code> here</p>
<p>The following attributes need to be set if you need DataPull to alert you if a job runs for too little time or if it runs too long. </p>
<ul>
<li>datapull.logger.mssql.server: Put <code>{{server}}</code> here</li>
<li>datapull.logger.mssql.database: Put <code>{{database}}</code> here</li>
<li>datapull.logger.mssql.login: Put <code>{{login}}</code> here</li>
<li>datapull.logger.mssql.password: Put <code>{{password}}</code> here</li>
<li>datapull.logger.mssql.table: Put <code>{{table}}</code> here</li>
</ul>
<p>For the above functionality, DataPull also needs a SQL Server table <code>{{table}}</code> in the database <code>{{database}}</code> on the SQL Server instance <code>{{server}}</code>; and an SQL Server login <code>{{login}}</code> with password <code>{{password}}</code> that can write to this table. If this table does not exist, please create this table with the following schema...</p>
<pre><code>CREATE TABLE [{{table}}](
    [JobId] [nvarchar](max) NULL,
    [Portfolio] [nvarchar](max) NULL,
    [Product] [nvarchar](max) NULL,
    [MasterNode] [nvarchar](max) NULL,
    [Ec2Role] [nvarchar](max) NULL,
    [elapsedtime] [float] NOT NULL,
    [minexecutiontime] [bigint] NOT NULL,
    [maxexecutiontime] [bigint] NOT NULL,
    [status] [nvarchar](max) NULL,
    [InstantNow] [nvarchar](max) NULL,
    [processedflag] [bigint] NOT NULL,
    [EmailAddress] [nvarchar](max) NULL,
    [pipelineName] [nvarchar](max) NULL,
    [awsenv] [nvarchar](max) NULL,
    [BccEmailAddress] [nvarchar](max) NULL
)
</code></pre>
<p>The following attributes need to be set if you need DataPull to send an email report once each DataPull job completes, from the email address <code>{{emailaddress}}</code> through the SMTP server/relay <code>{{smtpserveraddress}}</code></p>
<ul>
<li>datapull.logger.smtp.emailaddress: Put <code>{{emailaddress}}</code> here</li>
<li>datapull.logger.smtp.smtpserveraddress: Put <code>{{smtpserveraddress}}</code> here</li>
</ul>
<p>The following attributes need to be set if you need DataPull to send an email report once each DataPull job completes, from the email address <code>{{emailaddress}}</code>  using an existing SES instance that is accessible to the DataPull's EC2 EMR Role.</p>
<ul>
<li>datapull.logger.ses.email: Put <code>{{emailaddress}}</code> here</li>
</ul>
<p>Optionally, you can provide AWS Credentials <code>{{access_key}}</code>/<code>{{secret_key}}</code> for use by SES  alone</p>
<ul>
<li>datapull.logger.ses.access_key: Put <code>{{access_key}}</code> here</li>
<li>datapull.logger.ses.secret_key: Put <code>{{secret_key}}</code> here</li>
</ul>
<p>The following attributes need to be set if you wish to run the EMR clusters for DataPull in any other security groups than the <a href="https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-man-sec-groups.html">default EMR security groups</a> that are created by AWS automatically when an EMR cluster is created</p>
<ul>
<li>datapull.emr.emr_security_group_master: Put <code>{{emr_security_group_master}}</code> here</li>
<li>datapull.emr.emr_security_group_slave: Put <code>{{emr_security_group_slave}}</code> here</li>
<li>datapull.emr.emr_security_group_service_access: Put <code>{{emr_security_group_service_access}}</code> here</li>
</ul>
<h3 id="optional-oracle-and-teradata-support">(optional) Oracle and Teradata support</h3>
<p>Please follow the instructions on <a href="/oracle_teradata_support">this wiki</a> to use Oracle and/or Teradata as data sources/destinations for DataPull.</p>
<h3 id="create-datapull-infrastructure">Create DataPull Infrastructure</h3>
<h4 id="optional-add-support-for-datapull-api-to-be-served-over-https">(optional) Add support for DataPull API to be served over HTTPS</h4>
<ul>
<li>Edit the file <code>/api/terraform/datapull_task/datapull_ecs.tf</code><ul>
<li>Update the resource <code>aws_alb_listener</code> with <ul>
<li>protocol as <code>"HTTPS"</code> (instead of <code>"HTTP"</code>)</li>
<li>port as <code>443</code> (instead of <code>8080</code>)</li>
<li>uncomment line <code># certificate_arn = var.load_balancer_certificate_arn</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="create-iam-user-and-roles-with-policies">Create IAM User and Roles, with policies</h4>
<blockquote>
<p>We recommend team managing the AWS account run this script from a terminal that has the AWS administrator credentials available as a profile <code>{{aws_admin_profile}}</code> in the <a href="https://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/credentials.html">Credential Profile Chain</a> i.e. you should have the AWS credentials set in</p>
</blockquote>
<ul>
    <li>either your `~/.aws/credentials` file if you're on a Mac
    <li>or in your environment variables, 
    <li>or you are running this script from an AWS instance with an IAM Role that has administrator privileges 
</ul>

<ul>
<li>From the terminal at the root of the repo, run </li>
</ul>
<pre><code class="language-shell">cd api/terraform/datapull_iam/
chmod +x create_user_and_roles.sh
./create_user_and_roles.sh {{aws_admin_profile}} {{s3_bucket_name}} {{region}}
</code></pre>
<ul>
<li>The script will create <ul>
<li>IAM Roles needed to run AWS Fargate and EMR</li>
<li>an IAM User <code>datapull_user</code> whose access key and secret key are created as a new AWS profile <code>datapull_user</code> using <a href="https://docs.aws.amazon.com/cli/latest/reference/configure/">aws configure CLI</a> </li>
</ul>
</li>
</ul>
<blockquote>
<p>The IAM User <code>datapull_user</code> is used to install the remaining DataPull components like the AWS Fargate Cluster, the API load balancer, etc., so we recommend using <code>datapull_user</code> to set up a CI/CD pipeline for the next step. </p>
</blockquote>
<h4 id="create-aws-fargate-api-app-and-other-aws-resources">Create AWS Fargate API App and other AWS resources</h4>
<ul>
<li>Ensure that there exists an AWS Profile <code>datapull_user</code> corresponding to the IAM User <code>datapull_user</code> created by the previous step
    &gt; Pro-tip: You can verify this on a Mac by running the terminal command <code>cat ~/.aws/credentials</code></li>
<li>From the terminal (assuming you are using the same terminal session as the previous steps), run </li>
</ul>
<pre><code class="language-shell">cd ../datapull_task/
# If you are at the root of the repo, run `cd api/terraform/datapull_task/`
chmod +x ecs_deploy.sh
./ecs_deploy.sh {{env}}
</code></pre>
<h4 id="browse-to-the-datapull-api-swagger-endpoint">Browse to the DataPull API Swagger endpoint</h4>
<ul>
<li>On AWS Console, navigate to <code>Services &gt; EC2 &gt; Load Balancing &gt; Load Balancers</code>, and record the DNS name for DataPull's ALB (which is named <code>{{s3_bucket_name}}-api-alb</code>) as <code>{{datpull_alb_internal_name}}</code> (e.g. <code>internal-datatools-datapull-api-alb-507903794.us-west-2.elb.amazonaws.com</code>)</li>
<li>On your browser, open the API endpoint URL <code>http://{{datpull_alb_internal_name}}:8080/swagger-ui.html#!/data45pull45request45handler/startDataPullUsingPOST</code><ul>
<li>If you have selected private subnets for <code>{{application_subnet_1}}</code>,  <code>{{application_subnet_2}}</code>, or if these subnets are accessible only through a bastion host, please port-forward  <code>{{datpull_alb_internal_name}}:8080</code> using the terminal command <code>ssh -i "{{pem file for your ssh key}}" -N -L 8080:{{datpull_alb_internal_name}}:8080 {{bastion user}}@{{bastion host address}}</code> and then open the API endpoint URL <code>http://localhost:8080/swagger-ui.html#!/data45pull45request45handler/startDataPullUsingPOST</code><ul>
<li>if you are using a bastion host, please ensure that bastion host is a part of <code>{{application_security_group}}</code> (along with other security groups it might need for access from your client network)</li>
<li>if you are a EC2 instance in your public subnet as a poor man's bastion host as described in the <a href="/aws_account_setup">AWS Account Setup</a> wiki, then <code>{{bastion user}}</code> is <code>ec2-user</code> and <code>{{bastion host address}}</code> is the public IP of the EC2 instance</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="do-your-first-datapull">Do your first DataPull</h2>
<ul>
<li>Create a csv file at the S3 location <code>s3://{{s3_bucket_name}}/datapull-opensource/data/firstdatapull/source/helloworld.csv</code> with the following data</li>
</ul>
<pre><code>hellofield,worldfield
hello,world
</code></pre>
<ul>
<li>Post the following JSON input to the API endpoint url <code>http://{{datpull_alb_internal_name}}:8080/swagger-ui.html#!/data45pull45request45handler/startDataPullUsingPOST</code> .<ul>
<li>Please remember to replace <code>{{your_id@DOMAIN.com}}</code> and <code>{{s3_bucket_name}}</code> with valid data. </li>
</ul>
</li>
</ul>
<pre><code>{
    &quot;useremailaddress&quot;: &quot;{{your_id@DOMAIN.com}}&quot;,
    &quot;precisecounts&quot;: true,
    &quot;migrations&quot;: [
        {
            &quot;sources&quot;: [
                {
                    &quot;platform&quot;: &quot;s3&quot;,
                    &quot;s3path&quot;: &quot;{{s3_bucket_name}}/datapull-opensource/data/firstdatapull/source&quot;,
                    &quot;fileformat&quot;: &quot;csv&quot;
                }
            ],
            &quot;destination&quot;: {
                &quot;platform&quot;: &quot;s3&quot;,
                &quot;s3path&quot;: &quot;{{s3_bucket_name}}/datapull-opensource/data/firstdatapull/destination&quot;,
                &quot;fileformat&quot;: &quot;json&quot;,
                &quot;savemode&quot;: &quot;Overwrite&quot;
            }
        }
    ],
    &quot;cluster&quot;: {
        &quot;pipelinename&quot;: &quot;firstdatapull&quot;,
        &quot;awsenv&quot;: &quot;dev&quot;,
        &quot;portfolio&quot;: &quot;Data Engineering Services&quot;,
        &quot;terminateclusterafterexecution&quot;: &quot;true&quot;,
        &quot;product&quot;: &quot;Data Engineering Data Tools&quot;,
        &quot;ComponentInfo&quot;: &quot;00000000-0000-0000-0000-000000000000&quot;
    }
}
</code></pre>
<ul>
<li>In approximately 8 minutes (to account for the time taken for the ephemeral EMR cluster to spin up), you should get the data from the CSV converted into JSON and written to the S3 folder <code>s3://{{s3_bucket_name}}/datapull-opensource/data/firstdatapull/destination/</code></li>
<li>The logs for each DataPull invocation are available at <code>s3://{{s3_bucket_name}}/datapull-opensource/logs/DataPullHistory</code>. The logs for each migration with DataPull invocations are available at <code>s3://{{s3_bucket_name}}/datapull-opensource/logs/MigrationHistory</code></li>
<li>If you had configured the anonymous SMTP server for DataPull to send you email reports, you would get an email report with the subject <code>DataPull Report - firstdatapull (application_{{random_numbers}})</code></li>
<li>While the ephemeral EMR cluster is in the <code>Running</code> status, you can monitor the progress of the Spark job by browsing to the Spark UI at <code>http://{{ip of master node of EMR cluster}}:8088</code> . Please <a href="/monitor_spark_ui">read this wiki</a> for more information<ul>
<li>If you have selected a private subnet for <code>{{application_subnet_1}}</code> or if this subnet is accessible only through a bastion host, please port-forward  <code>{{ip of master node of EMR cluster}}:8088</code> and <code>{{ip of master node of EMR cluster}}:20888</code> using the terminal command <code>ssh -i "{{pem file for your ssh key}}" -N -L 8088:{{ip of master node of EMR cluster}}:8088 -L 20888:{{ip of master node of EMR cluster}}:20888 {{bastion user}}@{{bastion host address}}</code> and then open the API endpoint URL <a href="http://localhost:8088">http://localhost:8088</a></li>
</ul>
</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../architecture/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Architecture
            </div>
          </div>
        </a>
      
      
        <a href="../aws_account_setup/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Setup VPC etc. in AWS Account for DataPull install
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.4fa0e4ee.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.1d3bfcf1.min.js"></script>
      
    
  </body>
</html>